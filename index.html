<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MARKTOS | The 25-Layer Marketing Genome</title>

    <!-- PWA Meta Tags -->
    <meta name="application-name" content="MARKTOS">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MARKTOS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#7C3AED">
    <meta name="description" content="MARKTOS Genesis 001 - 25-Layer Marketing Genome Platform powered by ValidKernel">

    <!-- PWA Manifest (inline) -->
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22MARKTOS%20Genesis%22%2C%22short_name%22%3A%22MARKTOS%22%2C%22description%22%3A%2225-Layer%20Marketing%20Genome%20Platform%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230f0f23%22%2C%22theme_color%22%3A%22%237C3AED%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520100%2520100%27%253E%253Crect%2520fill%3D%27%25237C3AED%27%2520width%3D%27100%27%2520height%3D%27100%27%2520rx%3D%2720%27%2F%253E%253Ctext%2520x%3D%2750%27%2520y%3D%2765%27%2520font-size%3D%2750%27%2520text-anchor%3D%27middle%27%2520fill%3D%27white%27%2520font-family%3D%27monospace%27%253EM%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kernel: { primary: '#7C3AED', secondary: '#4F46E5', accent: '#06B6D4' }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        @keyframes gradientRotate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .gradient-bg {
            background: linear-gradient(-45deg, #0f0f23, #1a1a3e, #2d1b4e, #1e3a5f, #0f0f23);
            background-size: 400% 400%;
            animation: gradientRotate 15s ease infinite;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glow-purple { box-shadow: 0 0 30px rgba(124, 58, 237, 0.3); }
        .glow-cyan { box-shadow: 0 0 30px rgba(6, 182, 212, 0.3); }

        .nav-section { border-left: 2px solid rgba(255,255,255,0.1); padding-left: 12px; margin-left: 8px; }
        .nav-item { transition: all 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(124, 58, 237, 0.3); border-left: 2px solid #7C3AED; }

        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(124, 58, 237, 0.2); }

        .layer-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .layer-0-4 { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .layer-5-8 { background: rgba(245, 158, 11, 0.3); color: #fcd34d; }
        .layer-9-12 { background: rgba(34, 197, 94, 0.3); color: #86efac; }
        .layer-13-16 { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        .layer-17-20 { background: rgba(168, 85, 247, 0.3); color: #d8b4fe; }
        .layer-21-25 { background: rgba(236, 72, 153, 0.3); color: #f9a8d4; }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(124, 58, 237, 0.5); border-radius: 4px; }
    </style>
</head>
<body class="gradient-bg text-white min-h-screen">

    <!-- KERNEL STATUS BAR -->
    <div class="fixed top-0 left-0 right-0 h-1 bg-gradient-to-r from-purple-600 via-indigo-500 to-cyan-400 z-50"></div>

    <div class="flex min-h-screen">

        <!-- SIDEBAR -->
        <aside class="w-64 glass-dark flex flex-col fixed left-0 top-0 bottom-0 z-40 overflow-y-auto">

            <!-- LOGO -->
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-cyan-400 rounded-lg flex items-center justify-center">
                        <span class="mono font-bold text-lg">M</span>
                    </div>
                    <div>
                        <div class="mono font-bold text-lg">MARKTOS</div>
                        <div class="text-xs text-gray-400">v2.0 | VTI‚Ñ¢ Enterprise</div>
                    </div>
                </div>
            </div>

            <!-- KERNEL STATUS -->
            <div class="p-4 mx-4 mt-4 glass rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 rounded-full bg-green-400 pulse"></div>
                    <span class="mono text-xs text-green-400">KERNEL ACTIVE</span>
                </div>
                <div class="text-xs text-gray-400">Trust Level: L0_GOVERNANCE</div>
                <div class="text-xs text-gray-400">Session: VALID</div>
            </div>

            <!-- NAVIGATION -->
            <nav class="flex-1 p-4 space-y-6 overflow-y-auto">

                <!-- COMMAND CENTER -->
                <div>
                    <div class="nav-item active flex items-center gap-3 p-3 rounded-lg cursor-pointer" onclick="showLayer('dashboard')">
                        <span>üìä</span>
                        <span class="text-sm font-medium">Command Center</span>
                    </div>
                </div>

                <!-- LAYER 0-4: FOUNDATION -->
                <div>
                    <div class="flex items-center gap-2 mb-2 px-3">
                        <span class="layer-badge layer-0-4 mono">L0-4</span>
                        <span class="text-xs text-gray-400 uppercase tracking-wider">Foundation</span>
                    </div>
                    <div class="nav-section space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('kernel')">
                            <span>üß¨</span><span>Kernel Monitor</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('identity')">
                            <span>üë§</span><span>Identity</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('segmentation')">
                            <span>üéØ</span><span>Segmentation</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('data')">
                            <span>üíæ</span><span>Data Architecture</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('channels')">
                            <span>üì°</span><span>Channels</span>
                        </div>
                    </div>
                </div>

                <!-- LAYER 5-8: CONTENT & AUTOMATION -->
                <div>
                    <div class="flex items-center gap-2 mb-2 px-3">
                        <span class="layer-badge layer-5-8 mono">L5-8</span>
                        <span class="text-xs text-gray-400 uppercase tracking-wider">Content</span>
                    </div>
                    <div class="nav-section space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('content')">
                            <span>üìù</span><span>Content Engine</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('personalization')">
                            <span>‚ú®</span><span>Personalization</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('campaigns')">
                            <span>üöÄ</span><span>Campaigns</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('automation')">
                            <span>‚ö°</span><span>Automation</span>
                        </div>
                    </div>
                </div>

                <!-- LAYER 9-12: LEAD MANAGEMENT -->
                <div>
                    <div class="flex items-center gap-2 mb-2 px-3">
                        <span class="layer-badge layer-9-12 mono">L9-12</span>
                        <span class="text-xs text-gray-400 uppercase tracking-wider">Leads</span>
                    </div>
                    <div class="nav-section space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('leads')">
                            <span>üß≤</span><span>Lead Capture</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('scoring')">
                            <span>üìà</span><span>Lead Scoring</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('testing')">
                            <span>üß™</span><span>A/B Testing</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('analytics')">
                            <span>üìä</span><span>Analytics</span>
                        </div>
                    </div>
                </div>

                <!-- LAYER 13-16: COMPLIANCE & DELIVERY -->
                <div>
                    <div class="flex items-center gap-2 mb-2 px-3">
                        <span class="layer-badge layer-13-16 mono">L13-16</span>
                        <span class="text-xs text-gray-400 uppercase tracking-wider">Compliance</span>
                    </div>
                    <div class="nav-section space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('compliance')">
                            <span>üîí</span><span>Compliance</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('integrations')">
                            <span>üîó</span><span>Integrations</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('deliverability')">
                            <span>üì¨</span><span>Deliverability</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('audience')">
                            <span>üß†</span><span>Audience Intel</span>
                        </div>
                    </div>
                </div>

                <!-- LAYER 17-20: REVENUE & STRATEGY -->
                <div>
                    <div class="flex items-center gap-2 mb-2 px-3">
                        <span class="layer-badge layer-17-20 mono">L17-20</span>
                        <span class="text-xs text-gray-400 uppercase tracking-wider">Revenue</span>
                    </div>
                    <div class="nav-section space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('revenue')">
                            <span>üí∞</span><span>Revenue Intel</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('journeys')">
                            <span>üó∫Ô∏è</span><span>Journeys</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('abm')">
                            <span>üè¢</span><span>ABM</span>
                        </div>
                    </div>
                </div>

                <!-- LAYER 21-25: PLATFORM -->
                <div>
                    <div class="flex items-center gap-2 mb-2 px-3">
                        <span class="layer-badge layer-21-25 mono">L21-25</span>
                        <span class="text-xs text-gray-400 uppercase tracking-wider">Platform</span>
                    </div>
                    <div class="nav-section space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('experiments')">
                            <span>üî¨</span><span>Experiments</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('realtime')">
                            <span>‚ö°</span><span>Real-Time</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('privacy')">
                            <span>üõ°Ô∏è</span><span>Privacy</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showLayer('governance')">
                            <span>‚öôÔ∏è</span><span>Governance</span>
                        </div>
                    </div>
                </div>

                <!-- DATA TOOLS - v1.1 -->
                <div class="mt-4 pt-4 border-t border-white/10">
                    <div class="flex items-center gap-2 mb-3 px-3">
                        <span class="text-xs text-cyan-400 uppercase tracking-wider font-bold">Data Tools</span>
                    </div>
                    <div class="space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showModal('export-data')">
                            <span>üì§</span><span>Export LDS.json</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showModal('import-data')">
                            <span>üì•</span><span>Import LDS.json</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showModal('chat-parser')">
                            <span>üí¨</span><span>Chat Parser</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showModal('share-link')">
                            <span>üîó</span><span>Share via Link</span>
                        </div>
                    </div>
                </div>

                <!-- VTI - VERIFIABLE TRUST INFRASTRUCTURE v1.2 -->
                <div class="mt-4 pt-4 border-t border-white/10">
                    <div class="flex items-center gap-2 mb-3 px-3">
                        <span class="text-xs text-green-400 uppercase tracking-wider font-bold">VTI‚Ñ¢</span>
                    </div>
                    <div class="space-y-1">
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showModal('trust-score')">
                            <span>üõ°Ô∏è</span><span>Trust Score</span>
                            <span class="ml-auto text-xs mono text-green-400" id="sidebar-trust-score">--</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="showModal('audit-log')">
                            <span>üìú</span><span>Audit Log</span>
                        </div>
                        <div class="nav-item flex items-center gap-3 p-2 rounded cursor-pointer text-sm text-gray-300" onclick="exportComplianceReport()">
                            <span>üìä</span><span>Compliance Report</span>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- SIDEBAR FOOTER -->
            <div class="p-4 border-t border-white/10">
                <div class="text-xs text-gray-500 mono">
                    <div>VALIDKERNEL v1.0.0</div>
                    <div class="text-green-500">VTI‚Ñ¢ Enabled</div>
                    <div class="text-cyan-600 mt-1" id="install-hint" style="display:none;">üì± Tap to install</div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 ml-64 p-8">

            <!-- HEADER -->
            <header class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold mono" id="page-title">COMMAND CENTER</h1>
                    <p class="text-gray-400 mt-1" id="page-subtitle">Marketing Genome Dashboard</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="glass rounded-lg px-4 py-2 text-sm">
                        <span class="text-gray-400">Role:</span>
                        <span class="text-purple-400 mono ml-2">SUPER_ADMIN</span>
                    </div>
                    <button class="glass rounded-lg px-4 py-2 text-sm hover:bg-white/10 transition">
                        <span class="text-gray-400">üîî</span>
                    </button>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-cyan-400"></div>
                </div>
            </header>

            <!-- DASHBOARD CONTENT -->
            <div id="content-dashboard" class="layer-content">

                <!-- GENOME HEALTH -->
                <div class="grid grid-cols-5 gap-4 mb-8">
                    <div class="glass rounded-xl p-6 stat-card transition cursor-pointer glow-purple">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Total Contacts</div>
                        <div class="text-3xl font-bold mono">247,892</div>
                        <div class="text-xs text-green-400 mt-2">‚Üë 12.4% this month</div>
                    </div>
                    <div class="glass rounded-xl p-6 stat-card transition cursor-pointer">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Active Campaigns</div>
                        <div class="text-3xl font-bold mono">18</div>
                        <div class="text-xs text-cyan-400 mt-2">6 sending now</div>
                    </div>
                    <div class="glass rounded-xl p-6 stat-card transition cursor-pointer">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Emails Sent (30d)</div>
                        <div class="text-3xl font-bold mono">1.2M</div>
                        <div class="text-xs text-green-400 mt-2">98.2% delivered</div>
                    </div>
                    <div class="glass rounded-xl p-6 stat-card transition cursor-pointer">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Pipeline Value</div>
                        <div class="text-3xl font-bold mono">$2.4M</div>
                        <div class="text-xs text-purple-400 mt-2">847 opportunities</div>
                    </div>
                    <div class="glass rounded-xl p-6 stat-card transition cursor-pointer glow-cyan">
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Kernel Health</div>
                        <div class="text-3xl font-bold mono text-green-400">99.9%</div>
                        <div class="text-xs text-green-400 mt-2">All systems nominal</div>
                    </div>
                </div>

                <!-- LAYER GENOME VISUALIZATION -->
                <div class="glass rounded-xl p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold mono">25-LAYER GENOME STATUS</h2>
                        <div class="text-xs text-gray-400 mono">Real-time layer health</div>
                    </div>
                    <div class="grid grid-cols-25 gap-1" id="genome-grid">
                        <!-- Generated by JS -->
                    </div>
                    <div class="flex justify-between mt-4 text-xs text-gray-500">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded"></div> Healthy</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-yellow-500 rounded"></div> Warning</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-500 rounded"></div> Critical</div>
                        </div>
                        <div>L0: Kernel ‚Üí L25: Economics</div>
                    </div>
                </div>

                <!-- TWO COLUMN LAYOUT -->
                <div class="grid grid-cols-2 gap-8">

                    <!-- RECENT CAMPAIGNS -->
                    <div class="glass rounded-xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-bold mono">ACTIVE CAMPAIGNS</h2>
                            <button class="text-xs text-purple-400 hover:text-purple-300">View All ‚Üí</button>
                        </div>
                        <div class="space-y-4" id="campaign-list">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <!-- LEAD PIPELINE -->
                    <div class="glass rounded-xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-bold mono">LEAD PIPELINE</h2>
                            <button class="text-xs text-purple-400 hover:text-purple-300">View All ‚Üí</button>
                        </div>
                        <div class="space-y-4" id="pipeline-stages">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- AUTOMATION FLOWS -->
                <div class="glass rounded-xl p-6 mt-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold mono">AUTOMATION WORKFLOWS</h2>
                        <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition">+ New Workflow</button>
                    </div>
                    <div class="grid grid-cols-4 gap-4" id="workflow-grid">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- REAL-TIME ACTIVITY -->
                <div class="glass rounded-xl p-6 mt-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 bg-green-400 rounded-full pulse"></div>
                            <h2 class="text-lg font-bold mono">REAL-TIME ACTIVITY</h2>
                        </div>
                        <div class="text-xs text-gray-400 mono">Live stream</div>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto" id="activity-feed">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- KERNEL MONITOR -->
            <div id="content-kernel" class="layer-content hidden">
                <div class="glass rounded-xl p-6 mb-8">
                    <h2 class="text-xl font-bold mono mb-6">L0: KERNEL INVARIANTS</h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="glass-dark rounded-lg p-4">
                            <div class="mono text-sm text-purple-400 mb-2">IV.01: Trust Hierarchy</div>
                            <div class="text-xs text-gray-400">Authority flows: L0 ‚Üí L1 ‚Üí L2, NEVER upward</div>
                            <div class="mt-3 flex items-center gap-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-xs text-green-400">ENFORCED</span>
                            </div>
                        </div>
                        <div class="glass-dark rounded-lg p-4">
                            <div class="mono text-sm text-purple-400 mb-2">IV.02: Check-Then-Act</div>
                            <div class="text-xs text-gray-400">Every action validated before execution</div>
                            <div class="mt-3 flex items-center gap-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-xs text-green-400">ENFORCED</span>
                            </div>
                        </div>
                        <div class="glass-dark rounded-lg p-4">
                            <div class="mono text-sm text-purple-400 mb-2">IV.03: Deterministic Boundaries</div>
                            <div class="text-xs text-gray-400">Same input MUST produce same output</div>
                            <div class="mt-3 flex items-center gap-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-xs text-green-400">ENFORCED</span>
                            </div>
                        </div>
                        <div class="glass-dark rounded-lg p-4">
                            <div class="mono text-sm text-purple-400 mb-2">IV.04: Role-Based Permissions</div>
                            <div class="text-xs text-gray-400">6 roles with explicit permission matrix</div>
                            <div class="mt-3 flex items-center gap-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-xs text-green-400">ENFORCED</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-xl p-6">
                    <h2 class="text-xl font-bold mono mb-6">ROLE PERMISSION MATRIX</h2>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-gray-400 border-b border-white/10">
                                <th class="pb-3 mono">Role</th>
                                <th class="pb-3 mono">Level</th>
                                <th class="pb-3 mono">Permissions</th>
                            </tr>
                        </thead>
                        <tbody id="role-matrix">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CAMPAIGNS -->
            <div id="content-campaigns" class="layer-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <div></div>
                    <button class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition" onclick="showModal('new-campaign')">+ Create Campaign</button>
                </div>
                <div class="glass rounded-xl p-6">
                    <div class="grid grid-cols-3 gap-6" id="all-campaigns">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- LEADS -->
            <div id="content-leads" class="layer-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <div></div>
                    <button class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition" onclick="showModal('new-lead')">+ Capture Lead</button>
                </div>
                <div class="grid grid-cols-4 gap-4" id="lead-pipeline">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- AUTOMATION -->
            <div id="content-automation" class="layer-content hidden">
                <div class="glass rounded-xl p-6 mb-8">
                    <h2 class="text-xl font-bold mono mb-6">WORKFLOW BUILDER</h2>
                    <div class="glass-dark rounded-lg p-8 text-center">
                        <div class="text-6xl mb-4">‚ö°</div>
                        <div class="text-lg font-medium mb-2">Visual Workflow Canvas</div>
                        <div class="text-sm text-gray-400 mb-6">Drag and drop triggers, actions, and conditions</div>
                        <button class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition">Open Canvas Builder</button>
                    </div>
                </div>
                <div class="glass rounded-xl p-6">
                    <h2 class="text-xl font-bold mono mb-6">WORKFLOW TEMPLATES</h2>
                    <div class="grid grid-cols-3 gap-4" id="workflow-templates">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- ANALYTICS -->
            <div id="content-analytics" class="layer-content hidden">
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="glass rounded-xl p-6">
                        <div class="text-xs text-gray-400 uppercase mb-2">Open Rate</div>
                        <div class="text-3xl font-bold mono">32.4%</div>
                        <div class="text-xs text-green-400 mt-2">‚Üë 4.2% vs avg</div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <div class="text-xs text-gray-400 uppercase mb-2">Click Rate</div>
                        <div class="text-3xl font-bold mono">8.7%</div>
                        <div class="text-xs text-green-400 mt-2">‚Üë 1.3% vs avg</div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <div class="text-xs text-gray-400 uppercase mb-2">Conversion</div>
                        <div class="text-3xl font-bold mono">4.2%</div>
                        <div class="text-xs text-yellow-400 mt-2">‚Üí 0.1% vs avg</div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <div class="text-xs text-gray-400 uppercase mb-2">Revenue</div>
                        <div class="text-3xl font-bold mono">$847K</div>
                        <div class="text-xs text-green-400 mt-2">‚Üë 23% vs LM</div>
                    </div>
                </div>
                <div class="glass rounded-xl p-6">
                    <h2 class="text-xl font-bold mono mb-6">ENGAGEMENT FUNNEL</h2>
                    <div class="h-64 flex items-end justify-around gap-4 px-8">
                        <div class="text-center flex-1">
                            <div class="bg-gradient-to-t from-purple-600 to-purple-400 rounded-t-lg" style="height: 200px;"></div>
                            <div class="text-xs text-gray-400 mt-2">Sent</div>
                            <div class="mono text-sm">1.2M</div>
                        </div>
                        <div class="text-center flex-1">
                            <div class="bg-gradient-to-t from-purple-600 to-purple-400 rounded-t-lg" style="height: 180px;"></div>
                            <div class="text-xs text-gray-400 mt-2">Delivered</div>
                            <div class="mono text-sm">1.18M</div>
                        </div>
                        <div class="text-center flex-1">
                            <div class="bg-gradient-to-t from-purple-600 to-purple-400 rounded-t-lg" style="height: 120px;"></div>
                            <div class="text-xs text-gray-400 mt-2">Opened</div>
                            <div class="mono text-sm">382K</div>
                        </div>
                        <div class="text-center flex-1">
                            <div class="bg-gradient-to-t from-cyan-600 to-cyan-400 rounded-t-lg" style="height: 60px;"></div>
                            <div class="text-xs text-gray-400 mt-2">Clicked</div>
                            <div class="mono text-sm">103K</div>
                        </div>
                        <div class="text-center flex-1">
                            <div class="bg-gradient-to-t from-green-600 to-green-400 rounded-t-lg" style="height: 30px;"></div>
                            <div class="text-xs text-gray-400 mt-2">Converted</div>
                            <div class="mono text-sm">50K</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GENERIC LAYER PLACEHOLDER -->
            <div id="content-generic" class="layer-content hidden">
                <div class="glass rounded-xl p-12 text-center">
                    <div class="text-6xl mb-6" id="generic-icon">üß¨</div>
                    <h2 class="text-2xl font-bold mono mb-4" id="generic-title">LAYER MODULE</h2>
                    <p class="text-gray-400 mb-8" id="generic-desc">This layer module is part of the 25-layer marketing genome.</p>
                    <div class="inline-flex items-center gap-2 px-4 py-2 glass rounded-lg">
                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span class="mono text-sm">KERNEL VALIDATED</span>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL OVERLAY -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-8">
        <div class="glass rounded-xl p-8 max-w-lg w-full" id="modal-content">
            <!-- Modal content injected by JS -->
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-8 right-8 z-50 space-y-2"></div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MARKTOS KERNEL v2.0 - ValidKernel VTI‚Ñ¢ Enterprise Edition
        // Full 25-Layer Marketing Genome with Role-Based Access Control
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const MARKTOS_VERSION = '2.0.0';
        const STORAGE_KEY = 'marktos_data_v2';
        const AUDIT_KEY = 'marktos_audit_v1';
        const CONFIG_KEY = 'marktos_config_v1';

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // v2.0 GOVERNANCE - ROLE & FEATURE ACCESS CONTROL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const JOB_ROLES = {
            marketing_director: { label: 'Marketing Director', trustClass: 0, color: 'text-purple-400' },
            campaign_manager: { label: 'Campaign Manager', trustClass: 2, color: 'text-blue-400' },
            content_marketer: { label: 'Content Marketer', trustClass: 3, color: 'text-cyan-400' },
            sales_rep: { label: 'Sales Rep', trustClass: 2, color: 'text-green-400' },
            data_analyst: { label: 'Data Analyst', trustClass: 4, color: 'text-yellow-400' },
            compliance_officer: { label: 'Compliance Officer', trustClass: 1, color: 'text-red-400' },
            viewer: { label: 'Viewer', trustClass: 5, color: 'text-gray-400' }
        };

        const LAYER_ACCESS = {
            dashboard: { minTrust: 5, roles: ['*'] },
            kernel: { minTrust: 1, roles: ['marketing_director', 'compliance_officer'] },
            identity: { minTrust: 2, roles: ['marketing_director', 'campaign_manager', 'sales_rep'] },
            segmentation: { minTrust: 2, roles: ['marketing_director', 'campaign_manager', 'data_analyst'] },
            data: { minTrust: 1, roles: ['marketing_director', 'data_analyst'] },
            channels: { minTrust: 2, roles: ['marketing_director', 'campaign_manager', 'content_marketer'] },
            content: { minTrust: 3, roles: ['marketing_director', 'campaign_manager', 'content_marketer'] },
            personalization: { minTrust: 3, roles: ['marketing_director', 'campaign_manager', 'content_marketer'] },
            campaigns: { minTrust: 2, roles: ['marketing_director', 'campaign_manager'] },
            automation: { minTrust: 2, roles: ['marketing_director', 'campaign_manager'] },
            leads: { minTrust: 2, roles: ['marketing_director', 'campaign_manager', 'sales_rep'] },
            scoring: { minTrust: 2, roles: ['marketing_director', 'campaign_manager', 'sales_rep'] },
            testing: { minTrust: 2, roles: ['marketing_director', 'campaign_manager'] },
            analytics: { minTrust: 4, roles: ['marketing_director', 'campaign_manager', 'data_analyst'] },
            compliance: { minTrust: 1, roles: ['marketing_director', 'compliance_officer'] },
            integrations: { minTrust: 1, roles: ['marketing_director', 'data_analyst'] },
            deliverability: { minTrust: 2, roles: ['marketing_director', 'campaign_manager'] },
            audience: { minTrust: 2, roles: ['marketing_director', 'campaign_manager', 'data_analyst'] },
            revenue: { minTrust: 1, roles: ['marketing_director', 'sales_rep'] },
            journeys: { minTrust: 2, roles: ['marketing_director', 'campaign_manager'] },
            abm: { minTrust: 2, roles: ['marketing_director', 'sales_rep'] },
            experiments: { minTrust: 1, roles: ['marketing_director', 'data_analyst'] },
            realtime: { minTrust: 3, roles: ['marketing_director', 'campaign_manager'] },
            privacy: { minTrust: 1, roles: ['marketing_director', 'compliance_officer'] },
            governance: { minTrust: 0, roles: ['marketing_director'] }
        };

        // Current user config
        let currentConfig = {
            jobRole: 'marketing_director',
            trustClass: 0,
            enabledLayers: Object.keys(LAYER_ACCESS),
            theme: 'dark'
        };

        function loadConfig() {
            try {
                const stored = localStorage.getItem(CONFIG_KEY);
                if (stored) {
                    Object.assign(currentConfig, JSON.parse(stored));
                }
            } catch (e) {
                console.warn('[MARKTOS] Config load failed:', e);
            }
            applyAccessControl();
        }

        function saveConfig() {
            try {
                localStorage.setItem(CONFIG_KEY, JSON.stringify(currentConfig));
                logAudit('CONFIG_CHANGE', { jobRole: currentConfig.jobRole, trustClass: currentConfig.trustClass }, 'IV.04');
            } catch (e) {
                console.warn('[MARKTOS] Config save failed:', e);
            }
        }

        function canAccessLayer(layerId) {
            const layer = LAYER_ACCESS[layerId];
            if (!layer) return true;

            // Trust class 0 = super admin, always has access
            if (currentConfig.trustClass === 0) return true;

            // Check trust class (lower number = more access)
            if (currentConfig.trustClass > layer.minTrust) return false;

            // Check role
            if (layer.roles.includes('*')) return true;
            if (layer.roles.includes(currentConfig.jobRole)) return true;

            // Check if layer is explicitly enabled
            if (currentConfig.enabledLayers.includes(layerId)) return true;

            return false;
        }

        function applyAccessControl() {
            document.querySelectorAll('[data-layer]').forEach(el => {
                const layerId = el.dataset.layer;
                if (canAccessLayer(layerId)) {
                    el.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
                } else {
                    el.classList.add('opacity-50', 'pointer-events-none');
                }
            });
            updateRoleDisplay();
        }

        function updateRoleDisplay() {
            const roleEl = document.getElementById('current-role-display');
            if (roleEl) {
                const role = JOB_ROLES[currentConfig.jobRole];
                roleEl.innerHTML = `<span class="${role.color}">${role.label}</span> <span class="text-gray-500">(TC${currentConfig.trustClass})</span>`;
            }
        }

        function setJobRole(roleId) {
            if (JOB_ROLES[roleId]) {
                currentConfig.jobRole = roleId;
                currentConfig.trustClass = JOB_ROLES[roleId].trustClass;
                saveConfig();
                applyAccessControl();
                showToast(`Role changed to ${JOB_ROLES[roleId].label}`, 'success');
            }
        }

        function toggleLayerAccess(layerId) {
            const idx = currentConfig.enabledLayers.indexOf(layerId);
            if (idx > -1) {
                currentConfig.enabledLayers.splice(idx, 1);
            } else {
                currentConfig.enabledLayers.push(layerId);
            }
            saveConfig();
            applyAccessControl();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VTI‚Ñ¢ - VERIFIABLE TRUST INFRASTRUCTURE
        // Trademark of ValidKernel.com
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const auditLog = [];
        const MAX_AUDIT_ENTRIES = 500;

        function logAudit(action, details, invariant = null) {
            const entry = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                invariant: invariant,
                role: 'super_admin',
                trust_level: 'L0_GOVERNANCE',
                verified: true
            };

            auditLog.unshift(entry);

            // Keep log size manageable
            if (auditLog.length > MAX_AUDIT_ENTRIES) {
                auditLog.pop();
            }

            // Persist audit log
            saveAuditLog();

            // Update trust score display
            updateTrustScore();

            console.log(`[VTI‚Ñ¢] ${action}:`, details);
            return entry;
        }

        function saveAuditLog() {
            try {
                localStorage.setItem(AUDIT_KEY, JSON.stringify(auditLog.slice(0, MAX_AUDIT_ENTRIES)));
            } catch (e) {
                console.warn('[VTI‚Ñ¢] Audit log save failed:', e.message);
            }
        }

        function loadAuditLog() {
            try {
                const stored = localStorage.getItem(AUDIT_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    auditLog.length = 0;
                    auditLog.push(...parsed);
                    console.log('[VTI‚Ñ¢] Audit log loaded:', auditLog.length, 'entries');
                }
            } catch (e) {
                console.warn('[VTI‚Ñ¢] Audit log load failed:', e.message);
            }
        }

        function calculateTrustScore() {
            // Trust Score based on:
            // 1. Invariant compliance (all 4 enforced = 40 points)
            // 2. Audit log health (recent activity = 20 points)
            // 3. Data integrity (valid structure = 20 points)
            // 4. Session stability (no errors = 20 points)

            let score = 0;

            // Invariant compliance (4 invariants x 10 points each)
            score += 40; // All invariants always enforced in ValidKernel

            // Audit log health (has recent entries)
            const recentEntries = auditLog.filter(e => {
                const age = Date.now() - new Date(e.timestamp).getTime();
                return age < 24 * 60 * 60 * 1000; // Last 24 hours
            });
            score += Math.min(20, recentEntries.length * 2);

            // Data integrity
            if (data && data.campaigns && data.leads && data.workflows) {
                score += 20;
            }

            // Session stability (base points for running system)
            score += 20;

            return Math.min(100, score);
        }

        function updateTrustScore() {
            const score = calculateTrustScore();
            const el = document.getElementById('sidebar-trust-score');
            if (el) {
                el.textContent = score;
                el.className = `ml-auto text-xs mono ${score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            }
        }

        function exportComplianceReport() {
            const report = {
                report_type: 'VTI_COMPLIANCE_REPORT',
                generated: new Date().toISOString(),
                generator: 'MARKTOS Genesis v' + MARKTOS_VERSION,
                kernel: {
                    name: 'ValidKernel',
                    version: '1.0.0',
                    vti_enabled: true,
                    vti_trademark: 'Verifiable Trust Infrastructure‚Ñ¢'
                },
                trust_score: calculateTrustScore(),
                invariants: {
                    'IV.01_TRUST_HIERARCHY': { status: 'ENFORCED', description: 'Authority flows L0‚ÜíL1‚ÜíL2 only' },
                    'IV.02_CHECK_THEN_ACT': { status: 'ENFORCED', description: 'All actions validated before execution' },
                    'IV.03_DETERMINISTIC_BOUNDARIES': { status: 'ENFORCED', description: 'Same input produces same output' },
                    'IV.04_ROLE_BASED_PERMISSIONS': { status: 'ENFORCED', description: '6-role RBAC matrix active' }
                },
                audit_summary: {
                    total_entries: auditLog.length,
                    last_24h: auditLog.filter(e => Date.now() - new Date(e.timestamp).getTime() < 86400000).length,
                    last_7d: auditLog.filter(e => Date.now() - new Date(e.timestamp).getTime() < 604800000).length
                },
                recent_audit_entries: auditLog.slice(0, 50),
                data_summary: {
                    campaigns: data.campaigns.length,
                    leads: data.leads.length,
                    workflows: data.workflows.length
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `marktos_compliance_report_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logAudit('COMPLIANCE_EXPORT', { entries: auditLog.length, score: calculateTrustScore() }, 'IV.01');
            showToast('Compliance report exported', 'success');
        }

        function undoAction(entryId) {
            const entry = auditLog.find(e => e.id === entryId);
            if (!entry) {
                showToast('Action not found', 'error');
                return;
            }

            // Log the undo attempt
            logAudit('UNDO_ATTEMPT', { original_action: entry.action, original_id: entryId }, 'IV.02');
            showToast('Undo logged - manual restoration required', 'info');
        }

        // INVARIANT IV.01: Trust Hierarchy
        const TRUST_LEVELS = {
            L0_GOVERNANCE: 0,
            L1_KERNEL: 1,
            L2_PROPOSER: 2
        };

        // INVARIANT IV.04: Role-Based Permissions
        const ROLES = {
            super_admin: { level: 0, permissions: ['*'], color: 'text-purple-400' },
            admin: { level: 1, permissions: ['campaign:*', 'contact:*', 'settings:read'], color: 'text-blue-400' },
            manager: { level: 2, permissions: ['campaign:create', 'campaign:send', 'contact:read'], color: 'text-cyan-400' },
            editor: { level: 3, permissions: ['campaign:create', 'template:edit'], color: 'text-green-400' },
            analyst: { level: 4, permissions: ['report:*', 'analytics:read'], color: 'text-yellow-400' },
            viewer: { level: 5, permissions: ['read:*'], color: 'text-gray-400' }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PERSISTENCE LAYER (localStorage)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function saveData(silent = false) {
            try {
                const exportData = {
                    version: MARKTOS_VERSION,
                    exported: new Date().toISOString(),
                    kernel: 'ValidKernel v1.0.0',
                    vti_enabled: true,
                    data: data
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(exportData));
                if (!silent) {
                    logAudit('DATA_SAVE', { campaigns: data.campaigns.length, leads: data.leads.length }, 'IV.03');
                }
                console.log('[MARKTOS] Data saved to localStorage');
            } catch (e) {
                console.warn('[MARKTOS] localStorage save failed:', e.message);
            }
        }

        function loadData() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed.data) {
                        Object.assign(data, parsed.data);
                        console.log('[MARKTOS] Data loaded from localStorage');
                        return true;
                    }
                }
            } catch (e) {
                console.warn('[MARKTOS] localStorage load failed:', e.message);
            }
            return false;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EXPORT/IMPORT LDS.json
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function exportLDS() {
            const exportData = {
                '$schema': 'marktos-lds-v1',
                version: MARKTOS_VERSION,
                exported: new Date().toISOString(),
                kernel: {
                    name: 'ValidKernel',
                    version: '1.0.0',
                    trust_level: 'L0_GOVERNANCE'
                },
                campaigns: data.campaigns,
                leads: data.leads,
                workflows: data.workflows,
                layers: data.layers
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `marktos_backup_${new Date().toISOString().split('T')[0]}.lds.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logAudit('LDS_EXPORT', { campaigns: data.campaigns.length, leads: data.leads.length, workflows: data.workflows.length }, 'IV.03');
            showToast('LDS.json exported successfully', 'success');
            closeModal();
        }

        function importLDS(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);

                    // Validate schema
                    if (!imported.campaigns && !imported.leads && !imported.data) {
                        throw new Error('Invalid LDS.json format');
                    }

                    // Handle both direct data and nested data formats
                    const importedData = imported.data || imported;

                    if (importedData.campaigns) data.campaigns = importedData.campaigns;
                    if (importedData.leads) data.leads = importedData.leads;
                    if (importedData.workflows) data.workflows = importedData.workflows;

                    saveData(true);
                    logAudit('LDS_IMPORT', { campaigns: data.campaigns.length, leads: data.leads.length }, 'IV.02');
                    refreshAllViews();
                    showToast(`Imported: ${data.campaigns.length} campaigns, ${data.leads.length} leads`, 'success');
                    closeModal();
                } catch (err) {
                    logAudit('LDS_IMPORT_FAILED', { error: err.message }, 'IV.02');
                    showToast('Import failed: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHAT PARSER - Parse text into leads/contacts
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function parseChatText(text) {
            const leads = [];
            const lines = text.split('\n').filter(l => l.trim());

            // Pattern matching for common formats
            const emailRegex = /[\w.-]+@[\w.-]+\.\w+/gi;
            const phoneRegex = /[\+]?[(]?[0-9]{1,3}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,4}[-\s\.]?[0-9]{1,9}/g;
            const nameRegex = /^([A-Z][a-z]+\s+[A-Z][a-z]+)/;

            let currentLead = {};

            for (const line of lines) {
                const trimmed = line.trim();

                // Check for email
                const emails = trimmed.match(emailRegex);
                if (emails) {
                    if (currentLead.email) {
                        leads.push(currentLead);
                        currentLead = {};
                    }
                    currentLead.email = emails[0];
                }

                // Check for phone
                const phones = trimmed.match(phoneRegex);
                if (phones) {
                    currentLead.phone = phones[0];
                }

                // Check for name pattern
                const nameMatch = trimmed.match(nameRegex);
                if (nameMatch && !currentLead.name) {
                    currentLead.name = nameMatch[1];
                }

                // Check for company indicators
                if (trimmed.toLowerCase().includes('company:') || trimmed.toLowerCase().includes('org:')) {
                    currentLead.company = trimmed.split(':')[1]?.trim() || trimmed;
                }

                // Check for "Name - Company" format
                if (trimmed.includes(' - ') && !currentLead.name) {
                    const parts = trimmed.split(' - ');
                    currentLead.name = parts[0].trim();
                    currentLead.company = parts[1]?.trim();
                }

                // Check for "Name, Company" format
                if (trimmed.includes(', ') && !currentLead.name && !trimmed.includes('@')) {
                    const parts = trimmed.split(', ');
                    if (parts[0].split(' ').length <= 3) {
                        currentLead.name = parts[0].trim();
                        currentLead.company = parts[1]?.trim();
                    }
                }
            }

            // Don't forget last lead
            if (Object.keys(currentLead).length > 0) {
                leads.push(currentLead);
            }

            return leads;
        }

        function importFromChat() {
            const text = document.getElementById('chat-input').value;
            if (!text.trim()) {
                showToast('Please paste some text to parse', 'error');
                return;
            }

            const parsed = parseChatText(text);

            if (parsed.length === 0) {
                showToast('No leads found in text. Try formats like:\nJohn Doe - Acme Corp\njohn@acme.com', 'info');
                return;
            }

            // Convert to lead format and add to data
            parsed.forEach(p => {
                data.leads.push({
                    id: Date.now() + Math.random(),
                    name: p.name || 'Unknown',
                    company: p.company || 'Unknown',
                    email: p.email || '',
                    phone: p.phone || '',
                    value: 0,
                    stage: 'new',
                    score: 10
                });
            });

            saveData(true);
            logAudit('CHAT_IMPORT', { leads_added: parsed.length, names: parsed.map(p => p.name || p.email).slice(0, 5) }, 'IV.02');
            refreshAllViews();
            showToast(`Added ${parsed.length} leads from chat`, 'success');
            closeModal();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SHARE VIA LINK - Generate shareable data URL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function generateShareLink() {
            const shareData = {
                v: MARKTOS_VERSION,
                c: data.campaigns.slice(0, 10),
                l: data.leads.slice(0, 50)
            };

            const compressed = btoa(encodeURIComponent(JSON.stringify(shareData)));
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const shareUrl = `${baseUrl}?data=${compressed}`;

            document.getElementById('share-url').value = shareUrl;
            document.getElementById('share-url-container').classList.remove('hidden');

            // Check URL length
            if (shareUrl.length > 2000) {
                document.getElementById('share-warning').classList.remove('hidden');
            }
        }

        function copyShareLink() {
            const url = document.getElementById('share-url').value;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                document.getElementById('share-url').select();
                document.execCommand('copy');
                showToast('Link copied!', 'success');
            });
        }

        function loadFromShareLink() {
            const params = new URLSearchParams(window.location.search);
            const sharedData = params.get('data');

            if (sharedData) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(sharedData)));
                    if (decoded.c) data.campaigns = decoded.c;
                    if (decoded.l) data.leads = decoded.l;
                    saveData();
                    showToast('Shared data loaded!', 'success');
                    // Clean URL
                    window.history.replaceState({}, '', window.location.pathname);
                } catch (e) {
                    console.warn('[MARKTOS] Failed to load shared data:', e);
                }
            }
        }

        function refreshAllViews() {
            renderGenomeGrid();
            renderCampaigns('campaign-list', 4);
            renderPipeline('pipeline-stages');
            renderWorkflows('workflow-grid', 4);
            renderActivityFeed();
        }

        // DATA STORE - v2.0 Extended
        const data = {
            campaigns: [
                { id: 1, name: 'Q1 Welcome Series', type: 'automation', status: 'active', sent: 45000, opens: 18000, clicks: 4500 },
                { id: 2, name: 'Product Launch Blast', type: 'broadcast', status: 'active', sent: 120000, opens: 38000, clicks: 9600 },
                { id: 3, name: 'Win-Back Campaign', type: 'automation', status: 'active', sent: 8000, opens: 2400, clicks: 480 },
                { id: 4, name: 'Newsletter Weekly', type: 'recurring', status: 'scheduled', sent: 0, opens: 0, clicks: 0 },
                { id: 5, name: 'Cart Abandonment', type: 'triggered', status: 'active', sent: 12000, opens: 5400, clicks: 1800 },
                { id: 6, name: 'Renewal Reminder', type: 'automation', status: 'draft', sent: 0, opens: 0, clicks: 0 }
            ],
            leads: [
                { id: 1, name: 'Sarah Chen', company: 'TechCorp', email: 'sarah@techcorp.com', phone: '+1-555-0101', value: 25000, stage: 'qualified', score: 85, tags: ['enterprise', 'hot'] },
                { id: 2, name: 'Mike Wilson', company: 'StartupXYZ', email: 'mike@startupxyz.com', phone: '+1-555-0102', value: 15000, stage: 'new', score: 45, tags: ['smb'] },
                { id: 3, name: 'Emily Davis', company: 'Enterprise Inc', email: 'emily@enterprise.com', phone: '+1-555-0103', value: 75000, stage: 'proposal', score: 92, tags: ['enterprise', 'hot'] },
                { id: 4, name: 'James Park', company: 'GrowthCo', email: 'james@growthco.com', phone: '+1-555-0104', value: 35000, stage: 'contacted', score: 68, tags: ['midmarket'] },
                { id: 5, name: 'Lisa Wang', company: 'Digital Agency', email: 'lisa@digitalagency.com', phone: '+1-555-0105', value: 18000, stage: 'qualified', score: 78, tags: ['agency'] },
                { id: 6, name: 'David Kim', company: 'SaaS Corp', email: 'david@saascorp.com', phone: '+1-555-0106', value: 120000, stage: 'negotiation', score: 95, tags: ['enterprise', 'hot'] }
            ],
            workflows: [
                { id: 1, name: 'Welcome Series', trigger: 'signup', steps: 5, active: true },
                { id: 2, name: 'Onboarding Flow', trigger: 'first_login', steps: 8, active: true },
                { id: 3, name: 'Re-engagement', trigger: 'inactive_30d', steps: 4, active: true },
                { id: 4, name: 'Birthday Campaign', trigger: 'birthday', steps: 2, active: true },
                { id: 5, name: 'Post-Purchase', trigger: 'purchase', steps: 6, active: false },
                { id: 6, name: 'Lead Nurture', trigger: 'form_submit', steps: 12, active: true }
            ],
            // v2.0 - Segments
            segments: [
                { id: 1, name: 'VIP Customers', type: 'dynamic', conditions: [{ field: 'score', op: 'gte', value: 80 }], count: 3, color: 'purple' },
                { id: 2, name: 'New Leads', type: 'dynamic', conditions: [{ field: 'stage', op: 'eq', value: 'new' }], count: 1, color: 'blue' },
                { id: 3, name: 'At Risk', type: 'dynamic', conditions: [{ field: 'score', op: 'lt', value: 50 }], count: 1, color: 'red' },
                { id: 4, name: 'Enterprise', type: 'dynamic', conditions: [{ field: 'value', op: 'gte', value: 50000 }], count: 2, color: 'green' },
                { id: 5, name: 'Newsletter Subscribers', type: 'static', conditions: [], count: 145, color: 'cyan' }
            ],
            // v2.0 - Scoring Rules
            scoringRules: [
                { id: 1, name: 'Email Open', action: 'email_open', points: 5, decay: 30, active: true },
                { id: 2, name: 'Email Click', action: 'email_click', points: 10, decay: 30, active: true },
                { id: 3, name: 'Page Visit', action: 'page_visit', points: 3, decay: 14, active: true },
                { id: 4, name: 'Pricing Page', action: 'pricing_view', points: 25, decay: 7, active: true },
                { id: 5, name: 'Demo Request', action: 'demo_request', points: 50, decay: 0, active: true },
                { id: 6, name: 'Form Submit', action: 'form_submit', points: 20, decay: 30, active: true }
            ],
            // v2.0 - Journeys
            journeys: [
                { id: 1, name: 'Customer Onboarding', status: 'active', steps: 8, enrolled: 234, completed: 189, conversionRate: 81 },
                { id: 2, name: 'Trial to Paid', status: 'active', steps: 5, enrolled: 567, completed: 198, conversionRate: 35 },
                { id: 3, name: 'Renewal Journey', status: 'active', steps: 4, enrolled: 145, completed: 132, conversionRate: 91 },
                { id: 4, name: 'Win-Back', status: 'paused', steps: 6, enrolled: 89, completed: 23, conversionRate: 26 }
            ],
            // v2.0 - Content Templates
            templates: [
                { id: 1, name: 'Welcome Email', type: 'email', category: 'onboarding', usedCount: 45 },
                { id: 2, name: 'Newsletter Header', type: 'block', category: 'newsletter', usedCount: 156 },
                { id: 3, name: 'CTA Button', type: 'block', category: 'conversion', usedCount: 234 },
                { id: 4, name: 'Product Announcement', type: 'email', category: 'promotion', usedCount: 12 }
            ],
            // v2.0 - A/B Tests
            tests: [
                { id: 1, name: 'Subject Line Test', type: 'subject', status: 'running', variants: 2, winner: null, uplift: 0 },
                { id: 2, name: 'CTA Color Test', type: 'content', status: 'completed', variants: 3, winner: 'B', uplift: 23 },
                { id: 3, name: 'Send Time Test', type: 'timing', status: 'completed', variants: 4, winner: 'C', uplift: 15 }
            ],
            // v2.0 - Revenue Tracking
            revenue: {
                mtd: 145000,
                lastMonth: 128000,
                ytd: 1450000,
                pipeline: 387000,
                deals: [
                    { id: 1, name: 'TechCorp Expansion', value: 75000, stage: 'negotiation', probability: 80 },
                    { id: 2, name: 'Enterprise Inc Renewal', value: 120000, stage: 'proposal', probability: 90 },
                    { id: 3, name: 'SaaS Corp Upsell', value: 45000, stage: 'qualified', probability: 60 }
                ]
            },
            layers: Array.from({length: 25}, (_, i) => ({
                id: i,
                name: `Layer ${i}`,
                health: Math.random() > 0.1 ? (Math.random() > 0.2 ? 'healthy' : 'warning') : 'critical'
            }))
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function renderGenomeGrid() {
            const grid = document.getElementById('genome-grid');
            grid.innerHTML = data.layers.map((layer, i) => {
                const colors = { healthy: 'bg-green-500', warning: 'bg-yellow-500', critical: 'bg-red-500' };
                return `<div class="h-8 ${colors[layer.health]} rounded hover:scale-110 transition cursor-pointer" title="Layer ${i}: ${layer.health}"></div>`;
            }).join('');
        }

        function renderCampaigns(containerId, limit) {
            const container = document.getElementById(containerId);
            const campaigns = limit ? data.campaigns.slice(0, limit) : data.campaigns;

            container.innerHTML = campaigns.map(c => {
                const statusColors = { active: 'bg-green-500', scheduled: 'bg-blue-500', draft: 'bg-gray-500' };
                const openRate = c.sent > 0 ? ((c.opens / c.sent) * 100).toFixed(1) : 0;
                const clickRate = c.opens > 0 ? ((c.clicks / c.opens) * 100).toFixed(1) : 0;

                return `
                    <div class="glass-dark rounded-lg p-4 hover:bg-white/10 transition cursor-pointer">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs px-2 py-1 rounded ${statusColors[c.status]} text-white uppercase">${c.status}</span>
                            <span class="text-xs text-gray-400 mono">${c.type}</span>
                        </div>
                        <div class="font-medium mb-2">${c.name}</div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div><div class="text-xs text-gray-400">Sent</div><div class="mono text-sm">${(c.sent/1000).toFixed(1)}K</div></div>
                            <div><div class="text-xs text-gray-400">Open</div><div class="mono text-sm">${openRate}%</div></div>
                            <div><div class="text-xs text-gray-400">Click</div><div class="mono text-sm">${clickRate}%</div></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPipeline(containerId) {
            const container = document.getElementById(containerId);
            const stages = ['new', 'contacted', 'qualified', 'proposal', 'negotiation'];
            const stageNames = { new: 'New Leads', contacted: 'Contacted', qualified: 'Qualified', proposal: 'Proposal', negotiation: 'Negotiation' };

            container.innerHTML = stages.map(stage => {
                const stageLeads = data.leads.filter(l => l.stage === stage);
                const total = stageLeads.reduce((sum, l) => sum + l.value, 0);
                const pct = (stageLeads.length / data.leads.length) * 100;

                return `
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-400">${stageNames[stage]}</span>
                            <span class="mono">${stageLeads.length} ($${(total/1000).toFixed(0)}K)</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-purple-500 to-cyan-400 rounded-full transition-all" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLeadPipeline() {
            const container = document.getElementById('lead-pipeline');
            const stages = ['new', 'contacted', 'qualified', 'negotiation'];
            const stageNames = { new: 'New', contacted: 'Contacted', qualified: 'Qualified', negotiation: 'Negotiation' };

            container.innerHTML = stages.map(stage => {
                const stageLeads = data.leads.filter(l => l.stage === stage);
                return `
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4 pb-4 border-b border-white/10">
                            <span class="mono text-sm uppercase">${stageNames[stage]}</span>
                            <span class="bg-purple-600 text-xs px-2 py-1 rounded mono">${stageLeads.length}</span>
                        </div>
                        <div class="space-y-3">
                            ${stageLeads.map(l => `
                                <div class="glass-dark rounded-lg p-3 cursor-pointer hover:bg-white/10 transition">
                                    <div class="font-medium text-sm">${l.name}</div>
                                    <div class="text-xs text-gray-400">${l.company}</div>
                                    <div class="flex justify-between mt-2">
                                        <span class="mono text-xs text-green-400">$${(l.value/1000).toFixed(0)}K</span>
                                        <span class="mono text-xs text-purple-400">Score: ${l.score}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderWorkflows(containerId, limit) {
            const container = document.getElementById(containerId);
            const workflows = limit ? data.workflows.slice(0, limit) : data.workflows;

            container.innerHTML = workflows.map(w => `
                <div class="glass-dark rounded-lg p-4 hover:bg-white/10 transition cursor-pointer">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-2 h-2 rounded-full ${w.active ? 'bg-green-400' : 'bg-gray-400'}"></div>
                        <span class="text-xs text-gray-400 mono">${w.steps} steps</span>
                    </div>
                    <div class="font-medium text-sm mb-1">${w.name}</div>
                    <div class="text-xs text-gray-400">Trigger: ${w.trigger}</div>
                </div>
            `).join('');
        }

        function renderWorkflowTemplates() {
            const templates = [
                { name: 'Welcome Series', desc: '5-email onboarding sequence', icon: 'üëã' },
                { name: 'Cart Abandonment', desc: 'Recover lost sales', icon: 'üõí' },
                { name: 'Lead Nurture', desc: '12-week drip campaign', icon: 'üå±' },
                { name: 'Re-engagement', desc: 'Win back inactive contacts', icon: 'üîÑ' },
                { name: 'Post-Purchase', desc: 'Cross-sell and upsell', icon: 'üéÅ' },
                { name: 'Event Reminder', desc: 'Webinar/event sequences', icon: 'üìÖ' }
            ];

            document.getElementById('workflow-templates').innerHTML = templates.map(t => `
                <div class="glass-dark rounded-lg p-6 hover:bg-white/10 transition cursor-pointer text-center">
                    <div class="text-4xl mb-3">${t.icon}</div>
                    <div class="font-medium mb-1">${t.name}</div>
                    <div class="text-xs text-gray-400">${t.desc}</div>
                </div>
            `).join('');
        }

        function renderRoleMatrix() {
            document.getElementById('role-matrix').innerHTML = Object.entries(ROLES).map(([name, role]) => `
                <tr class="border-b border-white/5">
                    <td class="py-3 ${role.color} mono uppercase">${name}</td>
                    <td class="py-3 mono">${role.level}</td>
                    <td class="py-3 text-xs text-gray-400">${role.permissions.join(', ')}</td>
                </tr>
            `).join('');
        }

        function renderActivityFeed() {
            const activities = [
                { type: 'email_open', contact: 'Sarah Chen', campaign: 'Welcome Series', time: '2s ago' },
                { type: 'form_submit', contact: 'New Lead', campaign: 'Landing Page', time: '15s ago' },
                { type: 'email_click', contact: 'Mike Wilson', campaign: 'Product Launch', time: '32s ago' },
                { type: 'conversion', contact: 'Emily Davis', campaign: 'Cart Recovery', time: '1m ago' },
                { type: 'email_open', contact: 'James Park', campaign: 'Newsletter', time: '2m ago' },
                { type: 'unsubscribe', contact: 'Anonymous', campaign: 'Promo Blast', time: '3m ago' },
                { type: 'email_open', contact: 'Lisa Wang', campaign: 'Onboarding', time: '4m ago' },
            ];

            const icons = {
                email_open: 'üìß',
                email_click: 'üñ±Ô∏è',
                form_submit: 'üìù',
                conversion: 'üí∞',
                unsubscribe: 'üö™'
            };

            const colors = {
                email_open: 'text-blue-400',
                email_click: 'text-cyan-400',
                form_submit: 'text-green-400',
                conversion: 'text-purple-400',
                unsubscribe: 'text-red-400'
            };

            document.getElementById('activity-feed').innerHTML = activities.map(a => `
                <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded transition">
                    <span class="text-lg">${icons[a.type]}</span>
                    <div class="flex-1">
                        <span class="text-sm">${a.contact}</span>
                        <span class="text-gray-500 mx-2">‚Ä¢</span>
                        <span class="text-xs text-gray-400">${a.campaign}</span>
                    </div>
                    <span class="text-xs text-gray-500 mono">${a.time}</span>
                </div>
            `).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NAVIGATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const layerConfig = {
            dashboard: { title: 'COMMAND CENTER', subtitle: 'Marketing Genome Dashboard' },
            kernel: { title: 'L0: KERNEL MONITOR', subtitle: 'ValidKernel Trust Infrastructure' },
            identity: { title: 'L1: IDENTITY', subtitle: 'Contact Genome Management', icon: 'üë§' },
            segmentation: { title: 'L2: SEGMENTATION', subtitle: 'Audience Gene Splicing', icon: 'üéØ' },
            data: { title: 'L3: DATA ARCHITECTURE', subtitle: 'Unified Profile Proteins', icon: 'üíæ' },
            channels: { title: 'L4: CHANNELS', subtitle: 'Communication Cells', icon: 'üì°' },
            content: { title: 'L5: CONTENT ENGINE', subtitle: 'Template RNA', icon: 'üìù' },
            personalization: { title: 'L6: PERSONALIZATION', subtitle: 'Dynamic Enzymes', icon: '‚ú®' },
            campaigns: { title: 'L7: CAMPAIGNS', subtitle: 'Orchestration Organs' },
            automation: { title: 'L8: AUTOMATION', subtitle: 'Workflow Nervous System' },
            leads: { title: 'L9: LEAD MANAGEMENT', subtitle: 'Circulatory System' },
            scoring: { title: 'L10: LEAD SCORING', subtitle: 'Propensity Scoring Engine', icon: 'üìà' },
            testing: { title: 'L11: A/B TESTING', subtitle: 'Optimization Immune System', icon: 'üß™' },
            analytics: { title: 'L12: ANALYTICS', subtitle: 'Intelligence Brain' },
            compliance: { title: 'L13: COMPLIANCE', subtitle: 'Regulatory System', icon: 'üîí' },
            integrations: { title: 'L14: INTEGRATIONS', subtitle: 'Connective Tissue', icon: 'üîó' },
            deliverability: { title: 'L15: DELIVERABILITY', subtitle: 'Lymphatic System', icon: 'üì¨' },
            audience: { title: 'L16: AUDIENCE INTEL', subtitle: 'Cognitive System', icon: 'üß†' },
            revenue: { title: 'L17: REVENUE INTEL', subtitle: 'Metabolic System', icon: 'üí∞' },
            journeys: { title: 'L19: JOURNEYS', subtitle: 'Choreographic System', icon: 'üó∫Ô∏è' },
            abm: { title: 'L20: ABM', subtitle: 'Strategic System', icon: 'üè¢' },
            experiments: { title: 'L21: EXPERIMENTS', subtitle: 'Laboratory System', icon: 'üî¨' },
            realtime: { title: 'L22: REAL-TIME', subtitle: 'Reactive System', icon: '‚ö°' },
            privacy: { title: 'L23: PRIVACY', subtitle: 'Ethical System', icon: 'üõ°Ô∏è' },
            governance: { title: 'L24: GOVERNANCE', subtitle: 'Administrative System', icon: '‚öôÔ∏è' }
        };

        function showLayer(layerId) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event?.target?.closest('.nav-item')?.classList.add('active');

            // Hide all content
            document.querySelectorAll('.layer-content').forEach(c => c.classList.add('hidden'));

            // Get config
            const config = layerConfig[layerId] || { title: layerId.toUpperCase(), subtitle: 'Layer Module' };

            // Update header
            document.getElementById('page-title').textContent = config.title;
            document.getElementById('page-subtitle').textContent = config.subtitle;

            // Show appropriate content
            const contentEl = document.getElementById('content-' + layerId);
            if (contentEl) {
                contentEl.classList.remove('hidden');

                // Render specific content
                if (layerId === 'campaigns') renderCampaigns('all-campaigns');
                if (layerId === 'leads') renderLeadPipeline();
                if (layerId === 'automation') renderWorkflowTemplates();
                if (layerId === 'kernel') renderRoleMatrix();
            } else {
                // Show generic layer placeholder
                const generic = document.getElementById('content-generic');
                generic.classList.remove('hidden');
                document.getElementById('generic-icon').textContent = config.icon || 'üß¨';
                document.getElementById('generic-title').textContent = config.title;
                document.getElementById('generic-desc').textContent = `${config.subtitle} - Part of the 25-layer marketing genome.`;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODALS & TOAST
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function showModal(type) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            if (type === 'new-campaign') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-6">CREATE CAMPAIGN</h2>
                    <form onsubmit="createCampaign(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-400 uppercase mb-2">Campaign Name</label>
                                <input type="text" id="campaign-name" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500" required>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 uppercase mb-2">Type</label>
                                <select id="campaign-type" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500">
                                    <option value="broadcast">Broadcast</option>
                                    <option value="automation">Automation</option>
                                    <option value="triggered">Triggered</option>
                                    <option value="recurring">Recurring</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-8">
                            <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Cancel</button>
                            <button type="submit" class="flex-1 py-3 bg-purple-600 rounded-lg hover:bg-purple-700 transition font-medium">Create</button>
                        </div>
                    </form>
                `;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // v1.1 DATA TOOLS MODALS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            if (type === 'export-data') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-2">üì§ EXPORT LDS.JSON</h2>
                    <p class="text-gray-400 text-sm mb-6">Download your complete MARKTOS data backup</p>
                    <div class="glass-dark rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="text-gray-400">Campaigns:</span> <span class="mono text-cyan-400">${data.campaigns.length}</span></div>
                            <div><span class="text-gray-400">Leads:</span> <span class="mono text-cyan-400">${data.leads.length}</span></div>
                            <div><span class="text-gray-400">Workflows:</span> <span class="mono text-cyan-400">${data.workflows.length}</span></div>
                            <div><span class="text-gray-400">Format:</span> <span class="mono text-green-400">LDS.json</span></div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="closeModal()" class="flex-1 py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Cancel</button>
                        <button onclick="exportLDS()" class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 rounded-lg hover:opacity-90 transition font-medium">Download Backup</button>
                    </div>
                `;
            }

            if (type === 'import-data') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-2">üì• IMPORT LDS.JSON</h2>
                    <p class="text-gray-400 text-sm mb-6">Restore data from a backup file</p>
                    <div class="glass-dark rounded-lg p-8 mb-6 text-center border-2 border-dashed border-white/20 hover:border-purple-500 transition cursor-pointer" onclick="document.getElementById('file-input').click()">
                        <div class="text-4xl mb-3">üìÅ</div>
                        <div class="text-sm">Click to select LDS.json file</div>
                        <div class="text-xs text-gray-500 mt-1">or drag and drop</div>
                        <input type="file" id="file-input" accept=".json,.lds.json" class="hidden" onchange="importLDS(this.files[0])">
                    </div>
                    <div class="text-xs text-yellow-500 mb-4">‚ö†Ô∏è This will replace your current data</div>
                    <button onclick="closeModal()" class="w-full py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Cancel</button>
                `;
            }

            if (type === 'chat-parser') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-2">üí¨ CHAT PARSER</h2>
                    <p class="text-gray-400 text-sm mb-4">Paste text to auto-extract leads and contacts</p>
                    <div class="mb-4">
                        <textarea id="chat-input" class="w-full h-48 bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500 text-sm" placeholder="Paste contact info here...

Supported formats:
‚Ä¢ John Doe - Acme Corp
‚Ä¢ jane@company.com
‚Ä¢ Name, Company Name
‚Ä¢ Company: TechCorp
‚Ä¢ +1 (555) 123-4567"></textarea>
                    </div>
                    <div class="glass-dark rounded-lg p-3 mb-4 text-xs text-gray-400">
                        <strong class="text-cyan-400">Tip:</strong> The parser detects emails, phone numbers, names, and company names from common formats.
                    </div>
                    <div class="flex gap-4">
                        <button onclick="closeModal()" class="flex-1 py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Cancel</button>
                        <button onclick="importFromChat()" class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 rounded-lg hover:opacity-90 transition font-medium">Parse & Import</button>
                    </div>
                `;
            }

            if (type === 'share-link') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-2">üîó SHARE VIA LINK</h2>
                    <p class="text-gray-400 text-sm mb-6">Generate a shareable URL containing your data</p>
                    <div class="glass-dark rounded-lg p-4 mb-4">
                        <div class="text-sm mb-2"><span class="text-gray-400">Includes:</span></div>
                        <div class="text-xs text-gray-500">‚Ä¢ Up to 10 campaigns</div>
                        <div class="text-xs text-gray-500">‚Ä¢ Up to 50 leads</div>
                        <div class="text-xs text-gray-500">‚Ä¢ Encoded in URL (no server needed)</div>
                    </div>
                    <div id="share-url-container" class="hidden mb-4">
                        <label class="block text-xs text-gray-400 uppercase mb-2">Share URL</label>
                        <div class="flex gap-2">
                            <input type="text" id="share-url" readonly class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-xs mono focus:outline-none">
                            <button onclick="copyShareLink()" class="px-4 py-2 bg-cyan-600 rounded-lg hover:bg-cyan-700 transition text-sm">Copy</button>
                        </div>
                    </div>
                    <div id="share-warning" class="hidden text-xs text-yellow-500 mb-4">‚ö†Ô∏è URL is long and may not work in all browsers/apps</div>
                    <div class="flex gap-4">
                        <button onclick="closeModal()" class="flex-1 py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Cancel</button>
                        <button onclick="generateShareLink()" class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 rounded-lg hover:opacity-90 transition font-medium">Generate Link</button>
                    </div>
                `;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // v1.2 VTI‚Ñ¢ MODALS - Verifiable Trust Infrastructure
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            if (type === 'trust-score') {
                const score = calculateTrustScore();
                const scoreColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
                const scoreBar = score >= 80 ? 'from-green-600 to-green-400' : score >= 60 ? 'from-yellow-600 to-yellow-400' : 'from-red-600 to-red-400';

                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-2">üõ°Ô∏è VTI‚Ñ¢ TRUST SCORE</h2>
                    <p class="text-gray-400 text-sm mb-6">Verifiable Trust Infrastructure‚Ñ¢ by ValidKernel.com</p>

                    <div class="text-center mb-6">
                        <div class="text-6xl font-bold mono ${scoreColor}">${score}</div>
                        <div class="text-gray-400 text-sm mt-2">Trust Score (0-100)</div>
                        <div class="w-full bg-white/10 rounded-full h-3 mt-4">
                            <div class="h-3 rounded-full bg-gradient-to-r ${scoreBar}" style="width: ${score}%"></div>
                        </div>
                    </div>

                    <div class="glass-dark rounded-lg p-4 mb-4">
                        <div class="text-sm font-bold mb-3 text-purple-400">KERNEL INVARIANTS</div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span>IV.01: Trust Hierarchy</span>
                                <span class="text-green-400">‚úì ENFORCED</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>IV.02: Check-Then-Act</span>
                                <span class="text-green-400">‚úì ENFORCED</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>IV.03: Deterministic Boundaries</span>
                                <span class="text-green-400">‚úì ENFORCED</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>IV.04: Role-Based Permissions</span>
                                <span class="text-green-400">‚úì ENFORCED</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-dark rounded-lg p-4 mb-4">
                        <div class="text-sm font-bold mb-3 text-cyan-400">AUDIT SUMMARY</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>Total entries: <span class="mono text-white">${auditLog.length}</span></div>
                            <div>Last 24h: <span class="mono text-white">${auditLog.filter(e => Date.now() - new Date(e.timestamp).getTime() < 86400000).length}</span></div>
                        </div>
                    </div>

                    <button onclick="closeModal()" class="w-full py-3 bg-gradient-to-r from-purple-600 to-cyan-600 rounded-lg hover:opacity-90 transition font-medium">Close</button>
                `;
            }

            if (type === 'audit-log') {
                const recentLogs = auditLog.slice(0, 20);

                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-2">üìú VTI‚Ñ¢ AUDIT LOG</h2>
                    <p class="text-gray-400 text-sm mb-4">Complete action history with invariant verification</p>

                    <div class="max-h-96 overflow-y-auto mb-4">
                        ${recentLogs.length === 0 ? '<div class="text-center text-gray-500 py-8">No audit entries yet</div>' : recentLogs.map(entry => `
                            <div class="glass-dark rounded-lg p-3 mb-2">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-sm font-medium text-purple-400">${entry.action}</span>
                                    <span class="text-xs text-gray-500 mono">${new Date(entry.timestamp).toLocaleString()}</span>
                                </div>
                                <div class="text-xs text-gray-400 mb-1">${JSON.stringify(entry.details).slice(0, 80)}...</div>
                                <div class="flex gap-2 text-xs">
                                    ${entry.invariant ? `<span class="text-green-400">‚úì ${entry.invariant}</span>` : ''}
                                    <span class="text-cyan-400">${entry.trust_level}</span>
                                    <span class="${entry.verified ? 'text-green-400' : 'text-red-400'}">${entry.verified ? 'VERIFIED' : 'UNVERIFIED'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="flex gap-4">
                        <button onclick="closeModal()" class="flex-1 py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Close</button>
                        <button onclick="exportComplianceReport(); closeModal();" class="flex-1 py-3 bg-gradient-to-r from-green-600 to-cyan-600 rounded-lg hover:opacity-90 transition font-medium">Export Report</button>
                    </div>
                `;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // v2.0 GOVERNANCE MODAL - Role & Access Control
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            if (type === 'governance') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-2">‚öôÔ∏è GOVERNANCE</h2>
                    <p class="text-gray-400 text-sm mb-6">Role-based access control and feature toggles</p>

                    <div class="glass-dark rounded-lg p-4 mb-4">
                        <div class="text-sm font-bold mb-3 text-purple-400">CURRENT ROLE</div>
                        <select id="role-selector" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500" onchange="setJobRole(this.value)">
                            ${Object.entries(JOB_ROLES).map(([id, role]) => `
                                <option value="${id}" ${currentConfig.jobRole === id ? 'selected' : ''}>${role.label} (Trust Class ${role.trustClass})</option>
                            `).join('')}
                        </select>
                    </div>

                    <div class="glass-dark rounded-lg p-4 mb-4">
                        <div class="text-sm font-bold mb-3 text-cyan-400">TRUST CLASS</div>
                        <div class="text-4xl font-bold mono text-center text-cyan-400">${currentConfig.trustClass}</div>
                        <div class="text-xs text-gray-400 text-center mt-2">Lower = More Access (0-5)</div>
                    </div>

                    <div class="glass-dark rounded-lg p-4 mb-4 max-h-48 overflow-y-auto">
                        <div class="text-sm font-bold mb-3 text-green-400">LAYER ACCESS</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            ${Object.entries(LAYER_ACCESS).map(([id, config]) => `
                                <div class="flex items-center gap-2">
                                    <span class="${canAccessLayer(id) ? 'text-green-400' : 'text-red-400'}">${canAccessLayer(id) ? '‚úì' : '‚úó'}</span>
                                    <span class="${canAccessLayer(id) ? 'text-white' : 'text-gray-500'}">${id}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <button onclick="closeModal()" class="w-full py-3 bg-gradient-to-r from-purple-600 to-cyan-600 rounded-lg hover:opacity-90 transition font-medium">Close</button>
                `;
            }

            // v2.0 - New Segment Modal
            if (type === 'new-segment') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-6">üéØ CREATE SEGMENT</h2>
                    <form onsubmit="createSegment(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-400 uppercase mb-2">Segment Name</label>
                                <input type="text" id="segment-name" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500" placeholder="e.g., High-Value Leads" required>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 uppercase mb-2">Type</label>
                                <select id="segment-type" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500">
                                    <option value="dynamic">Dynamic (auto-update)</option>
                                    <option value="static">Static (manual)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 uppercase mb-2">Condition</label>
                                <div class="flex gap-2">
                                    <select id="segment-field" class="flex-1 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm">
                                        <option value="score">Lead Score</option>
                                        <option value="value">Deal Value</option>
                                        <option value="stage">Pipeline Stage</option>
                                    </select>
                                    <select id="segment-op" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm">
                                        <option value="gte">‚â•</option>
                                        <option value="lte">‚â§</option>
                                        <option value="eq">=</option>
                                    </select>
                                    <input type="text" id="segment-value" class="flex-1 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm" placeholder="Value">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-8">
                            <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Cancel</button>
                            <button type="submit" class="flex-1 py-3 bg-purple-600 rounded-lg hover:bg-purple-700 transition font-medium">Create Segment</button>
                        </div>
                    </form>
                `;
            }

            // v2.0 - New Scoring Rule Modal
            if (type === 'new-scoring-rule') {
                content.innerHTML = `
                    <h2 class="text-xl font-bold mono mb-6">üìà ADD SCORING RULE</h2>
                    <form onsubmit="createScoringRule(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-400 uppercase mb-2">Rule Name</label>
                                <input type="text" id="rule-name" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500" placeholder="e.g., Pricing Page Visit" required>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 uppercase mb-2">Trigger Action</label>
                                <select id="rule-action" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500">
                                    <option value="email_open">Email Open</option>
                                    <option value="email_click">Email Click</option>
                                    <option value="page_visit">Page Visit</option>
                                    <option value="form_submit">Form Submit</option>
                                    <option value="demo_request">Demo Request</option>
                                    <option value="pricing_view">Pricing Page View</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 uppercase mb-2">Points</label>
                                    <input type="number" id="rule-points" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500" value="10" min="1" max="100">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 uppercase mb-2">Decay (days)</label>
                                    <input type="number" id="rule-decay" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-500" value="30" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-8">
                            <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-white/20 rounded-lg hover:bg-white/10 transition">Cancel</button>
                            <button type="submit" class="flex-1 py-3 bg-purple-600 rounded-lg hover:bg-purple-700 transition font-medium">Add Rule</button>
                        </div>
                    </form>
                `;
            }

            overlay.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-purple-600' };
            const toast = document.createElement('div');
            toast.className = `${colors[type]} px-6 py-3 rounded-lg shadow-lg text-sm font-medium animate-pulse`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function createCampaign(e) {
            e.preventDefault();
            const name = document.getElementById('campaign-name').value;
            const type = document.getElementById('campaign-type').value;
            data.campaigns.unshift({ id: Date.now(), name, type, status: 'draft', sent: 0, opens: 0, clicks: 0 });
            saveData(true);
            logAudit('CAMPAIGN_CREATE', { name, type }, 'IV.04');
            closeModal();
            renderCampaigns('campaign-list', 4);
            showToast(`Campaign "${name}" created`);
        }

        // v2.0 - Create Segment
        function createSegment(e) {
            e.preventDefault();
            const name = document.getElementById('segment-name').value;
            const type = document.getElementById('segment-type').value;
            const field = document.getElementById('segment-field').value;
            const op = document.getElementById('segment-op').value;
            const value = document.getElementById('segment-value').value;

            data.segments.unshift({
                id: Date.now(),
                name,
                type,
                conditions: [{ field, op, value }],
                count: 0,
                color: ['purple', 'blue', 'green', 'cyan', 'red'][Math.floor(Math.random() * 5)]
            });

            saveData(true);
            logAudit('SEGMENT_CREATE', { name, type, conditions: `${field} ${op} ${value}` }, 'IV.04');
            closeModal();
            showToast(`Segment "${name}" created`);
            if (document.getElementById('content-segmentation')?.classList.contains('hidden') === false) {
                renderSegments();
            }
        }

        // v2.0 - Create Scoring Rule
        function createScoringRule(e) {
            e.preventDefault();
            const name = document.getElementById('rule-name').value;
            const action = document.getElementById('rule-action').value;
            const points = parseInt(document.getElementById('rule-points').value);
            const decay = parseInt(document.getElementById('rule-decay').value);

            data.scoringRules.push({
                id: Date.now(),
                name,
                action,
                points,
                decay,
                active: true
            });

            saveData(true);
            logAudit('SCORING_RULE_CREATE', { name, action, points }, 'IV.04');
            closeModal();
            showToast(`Scoring rule "${name}" added (+${points} points)`);
            if (document.getElementById('content-scoring')?.classList.contains('hidden') === false) {
                renderScoringRules();
            }
        }

        // v2.0 - Render Segments
        function renderSegments() {
            const container = document.getElementById('segments-grid');
            if (!container) return;

            const colorClasses = {
                purple: 'border-purple-500/50 bg-purple-500/10',
                blue: 'border-blue-500/50 bg-blue-500/10',
                green: 'border-green-500/50 bg-green-500/10',
                cyan: 'border-cyan-500/50 bg-cyan-500/10',
                red: 'border-red-500/50 bg-red-500/10'
            };

            container.innerHTML = data.segments.map(s => `
                <div class="glass-dark rounded-lg p-4 border-l-4 ${colorClasses[s.color] || 'border-white/20'}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium">${s.name}</span>
                        <span class="text-xs px-2 py-1 rounded ${s.type === 'dynamic' ? 'bg-cyan-500/20 text-cyan-400' : 'bg-gray-500/20 text-gray-400'}">${s.type}</span>
                    </div>
                    <div class="text-2xl font-bold mono mb-2">${s.count}</div>
                    <div class="text-xs text-gray-400">${s.conditions.length > 0 ? s.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(', ') : 'Manual list'}</div>
                </div>
            `).join('');
        }

        // v2.0 - Render Scoring Rules
        function renderScoringRules() {
            const container = document.getElementById('scoring-rules');
            if (!container) return;

            container.innerHTML = data.scoringRules.map(r => `
                <div class="glass-dark rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <div class="font-medium">${r.name}</div>
                        <div class="text-xs text-gray-400">${r.action} ‚Ä¢ Decay: ${r.decay > 0 ? r.decay + ' days' : 'Never'}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold mono ${r.points >= 20 ? 'text-green-400' : r.points >= 10 ? 'text-cyan-400' : 'text-gray-400'}">+${r.points}</div>
                        <div class="text-xs ${r.active ? 'text-green-400' : 'text-gray-500'}">${r.active ? 'Active' : 'Paused'}</div>
                    </div>
                </div>
            `).join('');
        }

        // v2.0 - Render Journeys
        function renderJourneys() {
            const container = document.getElementById('journeys-grid');
            if (!container) return;

            container.innerHTML = data.journeys.map(j => `
                <div class="glass-dark rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs px-2 py-1 rounded ${j.status === 'active' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${j.status}</span>
                        <span class="text-xs text-gray-400 mono">${j.steps} steps</span>
                    </div>
                    <div class="font-medium mb-3">${j.name}</div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div><div class="text-gray-400">Enrolled</div><div class="mono text-white">${j.enrolled}</div></div>
                        <div><div class="text-gray-400">Completed</div><div class="mono text-white">${j.completed}</div></div>
                        <div><div class="text-gray-400">Conversion</div><div class="mono ${j.conversionRate >= 50 ? 'text-green-400' : 'text-yellow-400'}">${j.conversionRate}%</div></div>
                    </div>
                </div>
            `).join('');
        }

        // v2.0 - Render Revenue
        function renderRevenue() {
            const container = document.getElementById('revenue-stats');
            if (!container) return;

            container.innerHTML = `
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-xs text-gray-400 uppercase mb-2">MTD Revenue</div>
                        <div class="text-3xl font-bold mono text-green-400">$${(data.revenue.mtd / 1000).toFixed(0)}K</div>
                        <div class="text-xs text-green-400 mt-1">+${((data.revenue.mtd / data.revenue.lastMonth - 1) * 100).toFixed(0)}% vs last</div>
                    </div>
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-xs text-gray-400 uppercase mb-2">YTD Revenue</div>
                        <div class="text-3xl font-bold mono text-purple-400">$${(data.revenue.ytd / 1000).toFixed(0)}K</div>
                    </div>
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-xs text-gray-400 uppercase mb-2">Pipeline</div>
                        <div class="text-3xl font-bold mono text-cyan-400">$${(data.revenue.pipeline / 1000).toFixed(0)}K</div>
                    </div>
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-xs text-gray-400 uppercase mb-2">Deals</div>
                        <div class="text-3xl font-bold mono text-white">${data.revenue.deals.length}</div>
                    </div>
                </div>
                <div class="glass-dark rounded-lg p-4">
                    <h3 class="text-sm font-bold mb-4 text-purple-400">TOP DEALS</h3>
                    ${data.revenue.deals.map(d => `
                        <div class="flex items-center justify-between py-3 border-b border-white/5 last:border-0">
                            <div>
                                <div class="font-medium">${d.name}</div>
                                <div class="text-xs text-gray-400">${d.stage}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold mono">$${(d.value / 1000).toFixed(0)}K</div>
                                <div class="text-xs text-green-400">${d.probability}% probability</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // v2.0 - Render Identity (Contacts)
        function renderIdentity() {
            const container = document.getElementById('identity-contacts');
            if (!container) return;

            container.innerHTML = data.leads.map(l => `
                <div class="glass-dark rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-cyan-400 flex items-center justify-center font-bold">${l.name.charAt(0)}</div>
                        <div>
                            <div class="font-medium">${l.name}</div>
                            <div class="text-xs text-gray-400">${l.company}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 space-y-1">
                        <div>üìß ${l.email || 'No email'}</div>
                        <div>üìû ${l.phone || 'No phone'}</div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        ${(l.tags || []).map(t => `<span class="text-xs px-2 py-1 rounded bg-purple-500/20 text-purple-400">${t}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        document.addEventListener('DOMContentLoaded', () => {
            // Load audit log first (before any other operations)
            loadAuditLog();

            // Load saved data
            loadData();

            // Check for shared data in URL
            loadFromShareLink();

            // Render all views
            renderGenomeGrid();
            renderCampaigns('campaign-list', 4);
            renderPipeline('pipeline-stages');
            renderWorkflows('workflow-grid', 4);
            renderActivityFeed();

            // Update trust score display
            updateTrustScore();

            // Log session start
            logAudit('SESSION_START', { version: MARKTOS_VERSION, vti_enabled: true }, 'IV.01');

            console.log('[MARKTOS] Kernel v' + MARKTOS_VERSION + ' initialized');
            console.log('[MARKTOS] VTI‚Ñ¢ (Verifiable Trust Infrastructure) ENABLED');
            console.log('[MARKTOS] Trust Level: L0_GOVERNANCE');
            console.log('[MARKTOS] 25-layer genome active');
            console.log('[MARKTOS] Trust Score:', calculateTrustScore());

            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-hint').style.display = 'block';
                document.getElementById('install-hint').onclick = () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((result) => {
                        if (result.outcome === 'accepted') {
                            showToast('MARKTOS installed!', 'success');
                        }
                        deferredPrompt = null;
                        document.getElementById('install-hint').style.display = 'none';
                    });
                };
            });

            // Register Service Worker for offline support
            if ('serviceWorker' in navigator) {
                // Inline service worker via blob
                const swCode = `
                    const CACHE_NAME = 'marktos-v${MARKTOS_VERSION}';
                    self.addEventListener('install', e => self.skipWaiting());
                    self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                    self.addEventListener('fetch', e => {
                        if (e.request.url.includes('cdn.tailwindcss.com') || e.request.url.includes('fonts.googleapis.com')) {
                            e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).then(res => {
                                const clone = res.clone();
                                caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
                                return res;
                            })));
                        }
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('[MARKTOS] Service Worker registered');
                }).catch(() => {
                    console.log('[MARKTOS] Service Worker not supported in this context');
                });
            }
        });

        // Close modal on overlay click
        document.getElementById('modal-overlay').addEventListener('click', e => {
            if (e.target.id === 'modal-overlay') closeModal();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });
    </script>

</body>
</html>
